<source>
  @type forward
  port 26226
  bind 0.0.0.0
  @label @from_docker
</source>

<source>
  type tail
  path /var/lib/docker/containers/*/*-json.log
  tag docker.*
  pos_file fluentd-docker.pos
  time_format %Y-%m-%dT%H:%M:%S
  format json
  read_from_head true
  @label @from_docker
</source>

<label @from_docker>
#   <match **>
#     @type rewrite_tag_filter
#     rewriterule1 container_name ^\/(\w+)$ docker.$1
#     rewriterule2 container_name ^.*$ docker.${tag_parts[1]}
#   </match>
  <match **>
    @type copy
    <store>
      @type relabel
      @label @filter_nginx
    </store>
    <store>
      @type relabel
      @label @filter_not_nginx
    </store>
  </match>
</label>

<label @filter_nginx>
  <filter **>
    @type grep
    regexp1 log ^type:nginx.*
  </filter>

  <filter **>
    @type parser
#    tag sales
    format ltsv
    key_name log
  </filter>

  <filter **>
    @type record_transformer
    enable_ruby true
    auto_typecast true

    <record>
      request_time ${record["request_time"].to_f}
    </record>
    <record>
      upstream_response_time ${record["upstream_response_time"].to_f}
    </record>
    <record>
      body_bytes_sent ${record["body_bytes_sent"].to_i}
    </record>
    <record>
      bytes_sent ${record["bytes_sent"].to_i}
    </record>
    <record>
      request_length ${record["request_length"].to_i}
    </record>
  </filter>

# never work.....
#   <match docker.*>
#     @type rewrite_tag_filter
#     rewriterule1 host \.* ${tag}.nginx
#   </match>

#    <match **>
#      @type file
#      path /tmp/test-nginx.log
#      time_slice_format %Y%m%d
#      time_slice_wait 10m
#      time_format %Y%m%dT%H%M%S%z
#    #   buffer_chunk_limit 32m
#      append true
#      compress gzip
#      utc
#    </match>
  <match **>
    @type relabel
    @label @default
  </match>
</label>

<label @filter_not_nginx>
  <filter **>
    @type grep
    exclude1 log ^type:nginx.*
  </filter>

#   <match **>
#     @type file
#     path /tmp/other.log
#     time_slice_format %Y%m%d
#     time_slice_wait 10m
#     time_format %Y%m%dT%H%M%S%z
#   #   buffer_chunk_limit 32m
#     append true
#     compress gzip
#     utc
#   </match>
  <match **>
    @type relabel
    @label @default
  </match>
</label>

