<source>
  @type dstat
  tag dstat_unparsed
  # option -c
  option -Tpams -N {{ pif_names[0] }} --tcp --udp --noupdate # --top-mem # 60  ## option -c
  delay 10
</source>

# <match dstat_unparsed>
#   @type stdout
# </match>
# 2017-04-09 19:44:03 +0900 dstat_unparsed: {"hostname":"subuntu1","dstat":{"epoch":{"epoch":"1491734643.106"},"procs":{"run":"0.0","blk":"0.0","new":"0.0"},"total_cpu_usage":{"usr":"1.020","sys":"1.020","idl":"97.959","wai":"0.0","hiq":"0.0","siq":"0.0"},"dsk/total":{"read":"0.0","writ":"0.0"},"net/total":{"recv":"272.0","send":"294.0"},"paging":{"in":"0.0","out":"0.0"},"system":{"int":"170.0","csw":"335.0"},"memory_usage":{"used":"1098448896.0","buff":"119414784.0","cach":"668127232.0","free":"211521536.0"},"swap":{"used":"234479616.0","free":"1910902784.0"},"tcp_sockets":{"lis":"12.0","act":"23.0","syn":"0.0","tim":"0.0","clo":"0.0"},"udp":{"lis":"8.0","act":"1.0"},"most_expensive":{"memory process":"clamd / 401526784%"}}}

<filter dstat_unparsed>
  @type record_transformer
  enable_ruby true
  auto_typecast true
# http://oxynotes.com/?p=7566  
  # epoch
  <record>
    host ${record["hostname"]}
  </record>

  # epoch
  <record>
    timestamp ${record["dstat"]["epoch"]["epoch"].to_f}
  </record>

  # total_cpu_usage
  <record>
    cpu_hiq ${record["dstat"]["total_cpu_usage"]["hiq"].to_f}
  </record>
  <record>
    cpu_idl ${record["dstat"]["total_cpu_usage"]["idl"].to_f}
  </record>
  <record>
    cpu_siq ${record["dstat"]["total_cpu_usage"]["siq"].to_f}
  </record>
  <record>
    cpu_sys ${record["dstat"]["total_cpu_usage"]["sys"].to_f}
  </record>
  <record>
    cpu_usr ${record["dstat"]["total_cpu_usage"]["usr"].to_f}
  </record>
  <record>
    cpu_wai ${record["dstat"]["total_cpu_usage"]["wai"].to_f}
  </record>

  # memory_usage
  <record>
    mem_buff ${record["dstat"]["memory_usage"]["buff"].to_f}
  </record>
  <record>
    mem_cache ${record["dstat"]["memory_usage"]["cach"].to_f}
  </record>
  <record>
    mem_free ${record["dstat"]["memory_usage"]["free"].to_f}
  </record>
  <record>
    mem_used ${record["dstat"]["memory_usage"]["used"].to_f}
  </record>

  # swap
  <record>
    swap_free ${record["dstat"]["swap"]["free"].to_f}
  </record>
  <record>
    swap_used ${record["dstat"]["swap"]["used"].to_f}
  </record>
  
  # net/total
  <record>
    net_recv ${record["dstat"]["net/{{ pif_names[0] }}"]["recv"].to_f}
  </record>
  <record>
    net_send ${record["dstat"]["net/{{ pif_names[0] }}"]["send"].to_f}
  </record>

  # tcp_sockets
  <record>
    tcp_act ${record["dstat"]["tcp_sockets"]["act"].to_f}
  </record>
  <record>
    tcp_clo ${record["dstat"]["tcp_sockets"]["clo"].to_f}
  </record>
  <record>
    tcp_lis ${record["dstat"]["tcp_sockets"]["lis"].to_f}
  </record>
  <record>
    tcp_syn ${record["dstat"]["tcp_sockets"]["syn"].to_f}
  </record>
  <record>
    tcp_tim ${record["dstat"]["tcp_sockets"]["tim"].to_f}
  </record>

  # udp
  <record>
    udp_act ${record["dstat"]["udp"]["act"].to_f}
  </record>
  <record>
    udp_lis ${record["dstat"]["udp"]["lis"].to_f}
  </record>
  
  # paging
  <record>
    paging_in ${record["dstat"]["paging"]["in"].to_f}
  </record>
  <record>
    paging_out ${record["dstat"]["paging"]["out"].to_f}
  </record>

  # procs
  <record>
    procs_blk ${record["dstat"]["procs"]["blk"].to_f}
  </record>
  <record>
    procs_new ${record["dstat"]["procs"]["new"].to_f}
  </record>
  <record>
    procs_run ${record["dstat"]["procs"]["run"].to_f}
  </record>
  
  # dsk/total
  <record>
    dsk_read ${record["dstat"]["dsk/total"]["read"].to_f}
  </record>
  <record>
    dsk_write ${record["dstat"]["dsk/total"]["write"].to_f}
  </record>

  # system
  <record>
    system_csw ${record["dstat"]["system"]["csw"].to_f}
  </record>
  <record>
    system_int ${record["dstat"]["system"]["int"].to_f}
  </record>

  remove_keys dstat,hostname
</filter>

<match dstat_unparsed>
  @type rewrite_tag_filter
  rewriterule1 host \.* dstat
</match>

<match dstat>
  @type relabel
  @label @default
</match>
