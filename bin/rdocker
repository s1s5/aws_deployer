#!/bin/bash
# -*- mode: shell-script -*-

if [ $# == 0 ]; then
    echo "unset DOCKER_HOST"
    exit 0
fi

dir=/tmp/docker-${USER}
if [ ! -e ${dir} ]; then
    mkdir -p ${dir}
    chmod 700 ${dir}
fi

new_docker_host=${dir}/${1}.sock

script_dir=$(cd $(dirname ${BASH_SOURCE:-$0}); pwd)
PIDFILE=${dir}/${1}.pid
DAEMON=${script_dir}/run_daemon.sh
DAEMON_ARGS="${new_docker_host} ${1}"

if [ -e ${new_docker_host} ]; then
    docker -H "unix://${new_docker_host}" info &> /dev/null
    if [ $? == 0 ]; then
        echo "export DOCKER_HOST=unix://${new_docker_host}"
        exit 0
    fi
    start-stop-daemon --stop --pidfile ${PIDFILE} --quiet
    rm -f ${new_docker_host}
fi

start-stop-daemon --start --make-pidfile --pidfile ${PIDFILE} \
                  --background --user ${USER} \
                  --exec /bin/bash -- -c \
                  "exec ${DAEMON} ${DAEMON_ARGS} >> ${dir}/daemon.log 2>&1"

echo "export DOCKER_HOST=unix://${new_docker_host}"
