#!/bin/bash
# -*- mode: shell-script -*-


usage_exit() {
        echo "Usage: $0 [-h] [-H] <host alias>" 1>&2
        exit 1
}

FLAG_HOSTNAME_ONLY=0
while getopts Hh OPT
do
    case $OPT in
        H)  FLAG_HOSTNAME_ONLY=1
            ;;
        h)  usage_exit
            ;;
        \?) usage_exit
            ;;
    esac
done
shift $((OPTIND - 1))


if [ $# == 0 ]; then
    echo "unset DOCKER_HOST"
    exit 0
fi

dir=/tmp/docker-${USER}
if [ ! -e ${dir} ]; then
    mkdir -p ${dir}
    chmod 700 ${dir}
fi

new_docker_host=${dir}/${1}.sock

script_dir=$(cd $(dirname ${BASH_SOURCE:-$0}); pwd)
PIDFILE=${dir}/${1}.pid
DAEMON=${script_dir}/run_daemon.sh
DAEMON_ARGS="${new_docker_host} ${1}"
PREFIX="export DOCKER_HOST=unix://"
if [ $FLAG_HOSTNAME_ONLY = 1 ]; then
    PREFIX="unix://"
fi

if [ -e ${new_docker_host} ]; then
    docker -H "unix://${new_docker_host}" info &> /dev/null
    if [ $? == 0 ]; then
        echo "${PREFIX}${new_docker_host}"
        exit 0
    fi
    start-stop-daemon --stop --pidfile ${PIDFILE} --quiet
    rm -f ${new_docker_host}
fi

ssh ${1} docker -H unix:///var/run/docker.sock version &> /dev/null
if [ $? != 0 ]; then
    echo 'could not connect to docker in remote host. Please check config' 1>&2
    echo 'You must be able to run "docker -H unix:///var/run/docker.sock version" without sudo in remote host' 1>&2
    exit 1
fi
# need to check ssh version must be >= 6.7

start-stop-daemon --start --make-pidfile --pidfile ${PIDFILE} \
                  --background --user ${USER} \
                  --exec /bin/bash -- -c \
                  "exec ${DAEMON} ${DAEMON_ARGS} >> ${dir}/daemon.log 2>&1"

echo "${PREFIX}${new_docker_host}"
